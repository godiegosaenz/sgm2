<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                template="./../../template/template.xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html" xmlns="http://www.w3.org/1999/xhtml"
                xmlns:p="http://primefaces.org/ui"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:poue="http://primefaces.org/ui/extensions"
                xmlns:dlg="http://xmlns.jcp.org/jsf/composite/dialog">

    <ui:define name="head">
        <style type="text/css">
            .ui-datepicker .ui-datepicker-title select {
                font-size: 1em;
                margin: 1px 0;
                color: black;
            }
        </style>
    </ui:define>
    <ui:define name="content">
        <div align="center">

            <h1>Generar Liquidación</h1>

        </div>
        <h:form id="frmAlcPlus">
            <center>
                <p:outputLabel value="Tipo de Liquidación" style="height: 25px; font-size: 14px; font-weight: bold;" />
                <p:spacer width="10"/>
                <p:selectOneMenu value="#{plusvaliaAlcabalas.tipoLiquidacion}" converter="entityConverter" 
                                 converterMessage="Error al intentar realizar conversión" style="vertical-align: middle;" >
                    <f:selectItem itemLabel="Seleccione.." itemValue="#{null}"/>
                    <f:selectItems value="#{plusvaliaAlcabalas.tiposLiquidacions}" var="tipo" itemLabel="#{tipo.nombreTransaccion}" itemValue="#{tipo}"/>
                    <p:ajax update="frmAlcPlus" listener="#{plusvaliaAlcabalas.consultarRubros()}"/>
                </p:selectOneMenu>
            </center>
            <br/>
            <dlg:busquedaPredio predio="#{plusvaliaAlcabalas.predio}"
                                consultar="#{plusvaliaAlcabalas.consultar()}"
                                tipoCons="#{plusvaliaAlcabalas.tipoCons}" 
                                consultarModel="#{plusvaliaAlcabalas.validarClaveOtroCanton()}"
                                predioModel="#{plusvaliaAlcabalas.predioModel}"
                                alcabalasPlusvalia="true"
                                update="frmAlcPlus"/>

<!--            <dlg:consultaCodigoPredial id="consulta" tipoConsulta="# {informesResoluciones.tipoConsultaUrbano}"
                                      updateConsulta="consulta, mainForm:tvInforme:prediosUrbanos"
                                      predioModel="# {informesResoluciones.predioModel}"
                                      renderContribuyente="false"
                                      consultarEmisiones="# {informesResoluciones.consultarEmisiones()}"
                                      tipoPredio="true"
                                      renderConsultaDirecta="false"/>-->


            <br/>
            <p:panel rendered="#{plusvaliaAlcabalas.claveOtroCanton}">
                <p:panelGrid columns="8" style="width: 100%" layout="grid" 
                             columnClasses="ui-grid-col-2, ui-grid-col-4, ui-grid-col-1, ui-grid-col-2, ui-grid-col-1, ui-grid-col-2, ui-grid-col-1, ui-grid-col-2">
                    <p:outputLabel value="Urbanización /  Barrio / Ciudadela: "/>
                    <p:inputText id="c21" value="#{plusvaliaAlcabalas.predioModel.urbanizacion}"  style="width: 100%" />

                    <p:outputLabel value="Manzana: "/>
                    <p:inputText id="c11" value="#{plusvaliaAlcabalas.predioModel.mz}" readonly="true" style="width: 100%"/>

                    <p:outputLabel value="Solar: "/>
                    <p:inputText id="c33" value="#{plusvaliaAlcabalas.predioModel.lote}" readonly="true" style="width: 100%" />

                </p:panelGrid>
                <div align="center">
                    <h:panelGrid columns="2" >

                        <dlg:datosEntes ente="#{plusvaliaAlcabalas.vendedorPredioOtroCanton}"
                                        esPersona="#{plusvaliaAlcabalas.esPersonaVend}"
                                        buscar="#{plusvaliaAlcabalas.buscarEnte()}"
                                        header="Datos del Vendedor"
                                        seleccion="#{plusvaliaAlcabalas.seleccionarVendedor}"
                                        id="outVendedor"
                                        update="frmAlcPlus:outVendedor:outDatosEnte, frmAlcPlus:outVendedor"
                                        mostrarBuscar="true"/>
                    
                        <dlg:datosEntes ente="#{plusvaliaAlcabalas.comprador}"
                                        esPersona="#{plusvaliaAlcabalas.esPersonaComp}"
                                        buscar="#{plusvaliaAlcabalas.buscarEnte()}"
                                        header="Datos del comprador"
                                        seleccion="#{plusvaliaAlcabalas.seleccionarComprador}"
                                        id="outComprador1"
                                        update="frmAlcPlus:outComprador1:outDatosEnte, frmAlcPlus:outComprador1"
                                        mostrarBuscar="true"/>

                    </h:panelGrid>
                </div>
            </p:panel>
            <p:panel rendered="#{plusvaliaAlcabalas.seccion1}" >
                <p:panelGrid columns="8" style="width: 100%" layout="grid" 
                             columnClasses="ui-grid-col-2, ui-grid-col-4, ui-grid-col-1, ui-grid-col-2, ui-grid-col-1, ui-grid-col-2, ui-grid-col-1, ui-grid-col-2">
                    <p:outputLabel value="Urbanización /  Barrio / Ciudadela: "/>
                    <p:inputText id="c2" value="#{plusvaliaAlcabalas.predio.ciudadela.nombre}" readonly="true" style="width: 100%" />

                    <p:outputLabel value="Manzana: "/>
                    <p:inputText id="c1" value="#{plusvaliaAlcabalas.predio.mz}" readonly="true" style="width: 100%"/>

                    <p:outputLabel value="Solar: "/>
                    <p:inputText id="c3" value="#{plusvaliaAlcabalas.predio.solar}" readonly="true" style="width: 100%" />

                    <p:outputLabel value="Es Matriz: "/>
                    <p:selectBooleanCheckbox id="c4" value="#{plusvaliaAlcabalas.esMatriz}"  style="width: 100%" >
                        <p:ajax update="frmAlcPlus"/>
                    </p:selectBooleanCheckbox>
                </p:panelGrid>
                <br/>

                <br/>
                <h:panelGrid columns="5">
                    <p:dataTable value="#{plusvaliaAlcabalas.predio.catPredioPropietarioCollection}" rows="5" rowKey="#{prop.id}"
                                 style="width: 100% !important" selection="#{plusvaliaAlcabalas.vendedor}" var="prop" 
                                 selectionMode="single" rowIndexVar="index" paginator="true" paginatorPosition="top"
                                 emptyMessage="No se encontró ningún propietario asociado al predio." reflow="true">
                        <f:facet name="header">
                            <p:outputLabel value="Datos vendedor" style="font-size: 16px; font-weight: bold; color: #FFFFFF"/>
                        </f:facet>

                        <p:column style="width: 25%" headerText="Cedula o RUC">
                            <h:outputText value="#{prop.ente.ciRuc}" />
                        </p:column>
                        <p:column style="width: 40%" headerText="Nombres">
                            <h:outputText value="#{prop.ente.nombreCompleto}" />
                        </p:column>
                    </p:dataTable>
                    <div align="center">
                        <h:panelGroup>
                            <dlg:datosEntes ente="#{plusvaliaAlcabalas.comprador}"
                                            esPersona="#{plusvaliaAlcabalas.esPersonaComp}"
                                            buscar="#{plusvaliaAlcabalas.buscarEnte()}"
                                            header="Datos del comprador"
                                            seleccion="#{plusvaliaAlcabalas.seleccionarComprador}"
                                            id="outComprador"
                                            update="frmAlcPlus:outComprador:outDatosEnte, frmAlcPlus:outComprador"
                                            mostrarBuscar="true"/>
                        </h:panelGroup>
                    </div>
                    <p:spacer width="30"/>
                    <p:dataTable value="#{plusvaliaAlcabalas.detallePlusvalias}" rows="5" rowKey="#{prop.id}"
                                 style="width: 100% !important" var="predioAdj1"
                                 rowIndexVar="index" paginator="true" paginatorPosition="top"
                                 emptyMessage="No se adjuntado predios." reflow="true" 
                                 rendered="#{plusvaliaAlcabalas.esMatriz and !plusvaliaAlcabalas.alcabala}">
                        <f:facet name="header">
                            <p:outputLabel value="Predios Adicionales." style="font-size: 16px; font-weight: bold; color: #006699"/>
                            <p:commandLink actionListener="#{plusvaliaAlcabalas.mostrarDialog('/resources/dialog/predios')}" 
                                           style="float: right; vertical-align: middle;" title="Buscar Comprador"  >
                                <p:ajax event="dialogReturn" listener="#{plusvaliaAlcabalas.seleccionarPredios}" update="frmAlcPlus, frmAlcPlus:outComprador:outDatosEnte"  />
                                <p:graphicImage value="/css/homeIconsImages/buscar.png" height="25" width="25"/>
                            </p:commandLink>
                        </f:facet>

                        <p:column style="width: 25%" headerText="Cedula o RUC">
                            <h:outputText value="#{predioAdj1.prediosAsociados.numPredio}" />
                        </p:column>
                        <p:column style="width: 40%" headerText="Manzana">
                            <h:outputText value="#{predioAdj1.prediosAsociados.mz}" />
                        </p:column>
                        <p:column style="width: 40%" headerText="Solar">
                            <h:outputText value="#{predioAdj1.prediosAsociados.solar}" />
                        </p:column>
                        <p:column style="width: 40%" headerText="Nombres">
                            <h:outputText value="#{predioAdj1.prediosAsociados.nombreUrb}" />
                        </p:column>
                    </p:dataTable>
                </h:panelGrid>
            </p:panel>
            <br/>
            <p:panel rendered="#{plusvaliaAlcabalas.comprador != null}">
                <center>
                    <p:panelGrid columns="2" layout="grid" styleClass="ui-responsive">
                        <!--                        <p:outputLabel value="Meses de vigencia: "/>
                                                <poue:inputNumber value="# {plusvaliaAlcabalas.valoresCalc.vigencia}"/>-->
                        <p:outputLabel value="Fecha Escritura anterior: "/>
                        <p:calendar value="#{plusvaliaAlcabalas.valoresCalc.fechaEscritaAnt}" pattern="dd/MM/yyyy" navigator="true" style="color: #000000" />
                        <p:outputLabel value="Fecha Escritura Actual: "/>
                        <p:calendar value="#{plusvaliaAlcabalas.valoresCalc.fechaEscritaAct}" pattern="dd/MM/yyyy" navigator="true" style="color: #000000" />
                    </p:panelGrid>
                </center>
                <h:panelGrid columns="3" >
                    <!--                PLUSVALIA -->
                    <p:panelGrid id="pnlPlus" columns="4" rendered="#{plusvaliaAlcabalas.tipoLiquidacion.codigoTituloReporte == 95}" >
                        <p:outputLabel value="Fecha de Inscripción: "/>
                        <p:calendar id="l1" value="#{plusvaliaAlcabalas.liquidacion.fechaContratoAnt}" pattern="dd/MM/yyyy" navigator="true" style="color: #000000" valueChangeListener="#{plusvaliaAlcabalas.obtenerFaccionAnio()}">
                            <p:ajax listener="#{plusvaliaAlcabalas.obtenerFaccionAnio()}" event="dateSelect" process="@this" update="pnlPlus, frmAlcPlus:t1"/>
                        </p:calendar>
                        <p:outputLabel value="Precio de Venta: "/>
                        <poue:inputNumber id="l2" value="#{plusvaliaAlcabalas.liquidacion.cuantia}">
                            <p:ajax listener="#{plusvaliaAlcabalas.restarDiferenc()}" process="@this" update="pnlPlus"/>
                        </poue:inputNumber>

                        <p:outputLabel value="Costo Adquisición: "/>
                        <poue:inputNumber id="l3" value="#{plusvaliaAlcabalas.liquidacion.costoAdq}" >
                            <p:ajax listener="#{plusvaliaAlcabalas.restarDiferenc()}" process="@this" update="pnlPlus"/>
                        </poue:inputNumber>
                        <p:outputLabel value="Diferencia Neta: " />
                        <p:inputText id="l4" value="#{plusvaliaAlcabalas.valoresCalc.diferenciaNeta}" readonly="true" >
                            <f:convertNumber maxFractionDigits="2" minFractionDigits="2" currencySymbol="" type="currency"  />
                        </p:inputText>

                        <p:outputLabel value="Mejoras CEM/Construcción: " />
                        <poue:inputNumber id="l5" value="#{plusvaliaAlcabalas.valoresCalc.mejorasCemConst}" >
                            <p:ajax listener="#{plusvaliaAlcabalas.obtenerDifNet2()}" update="pnlPlus"/>
                        </poue:inputNumber>
                        <p:outputLabel value="Mejoras Urbanización: " />
                        <poue:inputNumber id="l6" value="#{plusvaliaAlcabalas.valoresCalc.mejorasUrb}" minValue="-999999999999999.99" maxValue="999999999999999.99" >
                            <p:ajax listener="#{plusvaliaAlcabalas.obtenerDifNet2()}" update="pnlPlus"/>
                        </poue:inputNumber>

                        <p:outputLabel value="Diferencia Neta 2: " />
                        <p:inputText id="l7" value="#{plusvaliaAlcabalas.valoresCalc.diferenciaNeta2}" readonly="true"  >
                            <f:convertNumber maxFractionDigits="2" minFractionDigits="2" currencySymbol="" type="currency" />
                        </p:inputText>
                        <p:outputLabel value="Rebajas General: " />
                        <h:panelGroup>
                            <p:inputText value="#{plusvaliaAlcabalas.valoresCalc.porcentajeRebaja}" readonly="true" style="width: 30px;"/>%
                            <p:inputText id="l8" value="#{plusvaliaAlcabalas.valoresCalc.rebajaGen}" readonly="true" style="width: 90px;" >
                                <f:convertNumber maxFractionDigits="2"  />
                            </p:inputText>
                        </h:panelGroup>

                        <p:outputLabel value="Base Desvalorización: " />
                        <p:inputText id="l9" value="#{plusvaliaAlcabalas.valoresCalc.baseDesvalorizacion}" readonly="true" >
                            <f:convertNumber maxFractionDigits="2"  minFractionDigits="2" currencySymbol="" type="currency" />
                        </p:inputText>
                        <p:outputLabel value="Desvalorización Monetaria: " />
                        <h:panelGroup>
                            <p:inputText value="#{plusvaliaAlcabalas.desvalorizacion.valor}" readonly="true" style="width: 40px;"/>% 
                            <p:inputText id="l10" value="#{plusvaliaAlcabalas.valoresCalc.desvalorizacionMonet}" readonly="true" style="width: 85px;" >
                                <f:convertNumber maxFractionDigits="2"  minFractionDigits="2"  />
                            </p:inputText>
                        </h:panelGroup>

                        <p:outputLabel value="Utilidad Imponible: " />
                        <p:inputText id="l11" value="#{plusvaliaAlcabalas.valoresCalc.utilidadImponib}" readonly="true"  >
                            <f:convertNumber maxFractionDigits="2" minFractionDigits="2" currencySymbol="" type="currency" />
                        </p:inputText>
                        <p:outputLabel value=""/>
                        <p:outputLabel value=""/>
                    </p:panelGrid>

                    <!--                ALCABALAS -->
                    <h:panelGrid columns="4" rendered="#{plusvaliaAlcabalas.tipoLiquidacion.codigoTituloReporte == 93}" >
                        <p:outputLabel  value="Fecha de Contrato Anterior "/>
                        <p:calendar id="A1" value="#{plusvaliaAlcabalas.liquidacion.fechaContratoAnt}" pattern="dd/MM/yyyy" navigator="true" style="color: #000000" valueChangeListener="#{plusvaliaAlcabalas.obtenerFaccionAnio()}">
                        </p:calendar>
                        <p:outputLabel value="Costo Adquisición: "  rendered="false"  />
                        <poue:inputNumber id="a2" value="#{plusvaliaAlcabalas.liquidacion.costoAdq}"  rendered="false" readonly="true" >
                        </poue:inputNumber>

                        <p:outputLabel value="Cuantia: " />
                        <poue:inputNumber id="a3" value="#{plusvaliaAlcabalas.liquidacion.cuantia}" >
                            <p:ajax listener="#{plusvaliaAlcabalas.calcularAlcabala()}"  update="dtRubros, t1"/>
                        </poue:inputNumber>
                        <p:outputLabel value="Descuento: " />
                        <poue:inputNumber id="a4" value="#{plusvaliaAlcabalas.valoresCalc.baseDesvalorizacion}" symbol="%" symbolPosition="R" maxValue="999.99" >
                            <p:ajax listener="#{plusvaliaAlcabalas.calcularAlcabala()}"  update="dtRubros, t1"/>
                        </poue:inputNumber>
                    </h:panelGrid>

                    <p:spacer width="10"/>

                    <h:panelGroup rendered="#{plusvaliaAlcabalas.tipoLiquidacion.codigoTituloReporte == 93 or plusvaliaAlcabalas.tipoLiquidacion.codigoTituloReporte == 95}">
                        <!--                    ALCABALA Y PLUSVALIA -->
                        <p:dataTable id="dtRubros" reflow="true" value="#{plusvaliaAlcabalas.rubrosLiquidacion}" 
                                     var="rub" rowIndexVar="index" style="width: 100%;" editable="true" editMode="cell" >
                            <p:column style="width: 5%">
                                <h:outputText value="#{index+1}" />
                            </p:column>
                            <p:column headerText="Descripción del Rubro" id="valorRubros">
                                <h:outputText value="#{rub.descripcion}" />
                            </p:column>
                            <p:column headerText="Valor a Cobrar por el Rubro" id="colValor" style="width: 25%; text-align: right">
                                <p:cellEditor>
                                    <f:facet name="output">
                                        <h:outputText value="$ #{rub.tipoValor.id == 2? rub.valorTotal : rub.valor}" rendered="#{rub.cobrar}" />
                                        <h:outputText value="$ 0.00" rendered="#{!rub.cobrar}" />
                                    </f:facet>
                                    <f:facet name="input">
                                        <p:inputText id="modelInput" value="#{rub.valorTotal}" rendered="#{rub.tipoValor.id == 2}" style="width: 95%; text-align: right">
                                            <p:ajax listener="#{plusvaliaAlcabalas.valorTotal()}" update="frmAlcPlus:t1, dtRubros"/>
                                            <f:convertNumber maxFractionDigits="2" minFractionDigits="2" pattern="$ #,##0.00"/>
                                        </p:inputText>
                                        <p:inputText value="#{rub.valor}" rendered="#{rub.tipoValor.id != 2}" style="width: 95%;text-align: right">
                                            <p:ajax listener="#{plusvaliaAlcabalas.valorTotal()}" update="frmAlcPlus:t1, dtRubros"/>
                                            <f:convertNumber maxFractionDigits="2" minFractionDigits="2" pattern="$ #,##0.00" />
                                        </p:inputText> 
                                    </f:facet>
                                </p:cellEditor>
                            </p:column>
                            <p:column id="colCobRub" headerText="Rubro a Cobrar" style="width: 15%; text-align: center;">
                                <!--<p:graphicImage value="/css/homeIconsImages/seleccionado.png" rendered="#{rub.cobrar}"/>-->
                                <p:selectBooleanCheckbox id="check" value="#{rub.cobrar}" >
                                    <p:ajax update="frmAlcPlus:t1, dtRubros" listener="#{plusvaliaAlcabalas.valorTotal()}"/>
                                </p:selectBooleanCheckbox>
                            </p:column>
                        </p:dataTable>

                        <br/>
                        <div align="center">
                            <p:outputLabel  value="Total a cancelar: " style="font-weight: bold;"/>
                            <p:outputLabel value="$ " style="font-weight: bold;"/>
                            <p:inputText id="t1" value="#{plusvaliaAlcabalas.liquidacion.totalPago}" readonly="true" >
                                <f:convertNumber maxFractionDigits="2" pattern="$ #,##0.00"  />
                            </p:inputText>
                        </div>
                    </h:panelGroup>

                </h:panelGrid>
            </p:panel>
            <br/>
            <center >
                <p:commandButton value="Procesar" oncomplete="PF('obs').show()" 
                                 icon="ui-icon-gear" styleClass="btnStyle" iconPos="r" 
                                 rendered="#{plusvaliaAlcabalas.comprador != null}" >
                    <p:confirm header="Advertencia" icon="ui-icon-info" message="¿Esta seguro de guardar los datos ingresados?" />
                </p:commandButton>
            </center>
        </h:form>
        <dlg:dialogNumLiquidacion headerDialog="#{plusvaliaAlcabalas.liquidacion.tipoLiquidacion.nombreTransaccion}"
                                  idLiq="#{plusvaliaAlcabalas.liquidacion.idLiquidacion}" 
                                  actionButton="#{plusvaliaAlcabalas.borrarDatos()}"
                                  update="frmAlcPlus"
                                  id="numLiquidacion"/>

        <p:dialog widgetVar="dlgConf" header="Información" height="100" 
                  width="250" modal="true" closeOnEscape="true" closable="true" 
                  position="center" positionType="absolute" 
                  resizable="false" responsive="true">

            <h:form id="conf">
                <p:outputLabel value="Desea continuar con la Alcabala"/>
                <br/>
                <br/>
                <center>
                    <p:commandButton value="Si" actionListener="#{plusvaliaAlcabalas.llenarAlcalbala(true)}" 
                                     oncomplete="PF('dlgConf').hide()" styleClass="btnStyle" update="frmAlcPlus:outComprador:outDatosEnte"/>
                    <p:commandButton value="No" actionListener="#{plusvaliaAlcabalas.llenarAlcalbala(false)}" 
                                     oncomplete="PF('dlgConf').hide()" styleClass="btnStyle" update="frmAlcPlus:outComprador:outDatosEnte"/>
                </center>
            </h:form>
        </p:dialog>
        <dlg:observaciones actionButton="#{plusvaliaAlcabalas.procesar()}"
                           observaciones="#{plusvaliaAlcabalas.liquidacion.observacion}"
                           placeHolder="Observaciones de la Liquidacion, campo no obligatorio."
                           requerido="false"
                           />

    </ui:define>

</ui:composition>
