<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                template="/template/template.xhtml"
                xmlns:pe="http://primefaces.org/ui/extensions"
                xmlns:p="http://primefaces.org/ui"
                xmlns:h="http://xmlns.jcp.org/jsf/html" xmlns="http://www.w3.org/1999/xhtml"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:dialog="http://xmlns.jcp.org/jsf/composite/dialog"
                xmlns:c="http://xmlns.jcp.org/jsp/jstl/core">
    <ui:define name="head">
        <script src="../../resources/pfJs/keyPress.js" type="text/javascript"></script>
        <style type="text/css">
            .ui-selectoneradio label{
                font-size: 1.2em;
                font-weight: bold;
            }
            .ui-datatable .ui-datatable-scrollable-body .ui-datatable thead th, .ui-datatable tbody td, .ui-datatable tfoot td, .ui-datatable tfoot th{
                height : 20px;
                padding: 3px 5px;
            } 
        </style>
    </ui:define>
    <ui:define name="content">
        <center>
            <h1>Elaboracion de Convenios Prediales</h1>
        </center>
        <h:form id="mainForm">
            <p:tabView id="tvRecaudaciones">
                <p:ajax event="tabChange" listener="#{pagoPrediales.onChangeTab}"/>
                <p:tab id="tabPagoPredial" title="PAGO PREDIAL URBANO">
                    <dialog:consultaCodigoPredial id="consulta" tipoConsulta="#{pagoPrediales.tipoConsulta}"
                                                  changeRadio="#{pagoPrediales.onChangeRadio}"
                                                  updateConsulta="consulta, mainForm:tvRecaudaciones:datos"
                                                  predioModel="#{pagoPrediales.predioModel}"
                                                  contribuyenteConsulta="#{pagoPrediales.contribuyenteConsulta}"
                                                  nombreComprador="#{pagoPrediales.nombreComprador}"
                                                  consultaContDirecta="#{pagoPrediales.consultarPorNombreComprador(1)}"
                                                  dlgSolicitante="PF('dlgSolicitante').show()"
                                                  ciudadelas="#{pagoPrediales.ciudadelas}"
                                                  consultarEmisiones="#{pagoPrediales.cleanValues()}"
                                                  updateFrmSolicitante=":frmSolicitante"
                                                  tipoPredio="true"/>                    

                    <p:panel id="datos">
                        <h:panelGroup layout="block" class="Container Wid100 MarTop10" >
                            <h:panelGroup layout="block" class="Container33" >
                                <h:panelGrid columns="2" >
                                    <h:panelGrid columns="2" >
                                        <h:outputText value="Deuda a financiar: " style="display: block;"/>
                                        <p:inputText value="#{pagoPrediales.totalEmisiones}" />
                                    </h:panelGrid>
                                    <p:commandButton value="Inciar Convenio" id="btn_procesar" actionListener="#{pagoPrediales.openDlgConvenio()}"  
                                                     styleClass="btnStyle"  >
                                        <p:confirm header="Advertencia" icon="ui-icon-info" message="¿Esta seguro de pasar a generar el convenio de pago?"/>
                                        <p:ajax event="dialogReturn" listener="#{pagoPrediales.procesarConvenio}"   />
                                    </p:commandButton>
                                </h:panelGrid>
                            </h:panelGroup>
                            <h:panelGroup layout="block" class="Container33" >
                                <div align="right">
                                    
                                    <p:commandButton value="Impresion de Soicitud de Remision"  actionListener="#{pagoPrediales.generarSolicitudReimisionInteres()}"  
                                                     styleClass="btnStyle"  >
                                        <p:confirm header="Advertencia" icon="ui-icon-info" message="¿Esta seguro de pasar a generar la Solicitud Remision de Interes?"/>
                                    </p:commandButton>
                                </div>
                            </h:panelGroup>
                            <h:panelGroup layout="block" class="Container33" >
                                <div align="right">
                                    
                                    <p:commandButton value="Remision de Interes"  actionListener="#{pagoPrediales.openDlgRemisionInteres()}"  
                                                     styleClass="btnStyle"  >
                                        <p:confirm header="Advertencia" icon="ui-icon-info" message="¿Esta seguro de pasar a generar la Remision de Interes?"/>
                                        <p:ajax event="dialogReturn" listener="#{pagoPrediales.procesarRemision}"   />
                                    </p:commandButton>
                                </div>
                            </h:panelGroup>
                        </h:panelGroup>

                        <div style="clear: both;"/>

                        <p:dataTable id="dtEmision" value="#{pagoPrediales.emisionesPrediales}" var="emision"  selection="#{pagoPrediales.emisionesPredialesTemp}"
                                     rowKey="#{emision.id}" scrollable="true" scrollHeight="350" lazy="true" reflow="true" rows="100">
                            <p:ajax event="toggleSelect" listener="#{pagoPrediales.onRowToggle()}" update="mainForm:tvRecaudaciones:datos"/>
                            <p:ajax event="rowSelectCheckbox" listener="#{pagoPrediales.onRowSelect}" update="mainForm:tvRecaudaciones:datos"/>
                            <p:ajax event="rowUnselectCheckbox" listener="#{pagoPrediales.onRowUnselect}" update="mainForm:tvRecaudaciones:datos"/>
                            <p:ajax event="rowSelect" listener="#{pagoPrediales.onRowSelect}" update="mainForm:tvRecaudaciones:datos" />
                            <p:ajax event="rowUnselect" listener="#{pagoPrediales.onRowUnselect}" update="mainForm:tvRecaudaciones:datos" />
                            <p:column  selectionMode="multiple"  style="width:16px;text-align:center" ></p:column>
                            <p:column headerText="*" style="width: 25px; text-align:center">
                                <p:graphicImage value="/image/circleGreen.png" height="12" rendered="#{emision.estadoLiquidacion.id eq 1 ? true : false}" title="#{emision.estadoLiquidacion.descripcion}"/>
                                <p:graphicImage value="/image/circleRed.png" height="12" rendered="#{emision.estadoLiquidacion.id eq 2 ? true : false}" title="#{emision.estadoLiquidacion.descripcion}"/>
                                <p:graphicImage value="/image/circleOrange.png" height="12" rendered="#{emision.estadoLiquidacion.id eq 7 ? true : false}" title="#{emision.estadoLiquidacion.descripcion}"/>
                                
                            </p:column>
                            <!--<p:column headerText="No." style="text-align: center;"  width="80"><p:outputLabel value="#{emision.idLiquidacion}" /></p:column>-->
                            <p:column headerText="Año" style="text-align: center;" width="60"><p:outputLabel value="#{emision.anio}"/></p:column>
                            <!--<p:column id="predio" headerText="N. Predio" style="text-align: center;" width="100"><p:outputLabel value="# {emision.predio.numPredio}"/></p:column>-->
                            <!--<p:column headerText="Mz./Sl." style="text-align: center;"  width="80"><p:outputLabel value="# {emision.predio.urbMz}/#{emision.predio.urbSolarnew}"/></p:column>-->
                            <p:column id="codPredial" headerText="Clave Catastral" style="text-align: center" width="180" ><p:outputLabel value="#{emision.predio.claveCat}"/></p:column>
                            <p:column headerText="Contribuyente" style="text-align: center" width="250">
                                #{emision.comprador==null?emision.nombreComprador :emision.comprador.nombreCompleto}
                            </p:column>
                            <p:column headerText="Avaluo" style="text-align: center;" width="100">
                                <h:outputText value="#{emision.avaluoMunicipal}">
                                    <f:convertNumber pattern="$ #,##0.00" />
                                </h:outputText>
                            </p:column>
                            <p:column headerText="Emision" style="text-align: center;" width="100">
                                <h:outputText value="#{emision.totalPago}">
                                    <f:convertNumber pattern="$ #,##0.00" />
                                </h:outputText>
                            </p:column>
                            <p:column headerText="Descuento" style="text-align: center;" width="100">
                                <h:outputText value="#{emision.descuento}">
                                    <f:convertNumber pattern="$ #,##0.00" />
                                </h:outputText>
                            </p:column>
                            <p:column headerText="Interes" style="text-align: center;" width="100">
                                <h:outputText value="#{emision.interes}">
                                    <f:convertNumber pattern="$ #,##0.00" />
                                </h:outputText>
                            </p:column>
                            <p:column headerText="Recargo" style="text-align: center;" width="100">
                                <h:outputText value="#{emision.recargo}">
                                    <f:convertNumber pattern="$ #,##0.00" />
                                </h:outputText>
                            </p:column>

                            <p:column headerText="Coactiva" style="text-align: center;" width="80">
                                <h:outputText value="#{emision.valorCoactiva}">
                                    <f:convertNumber pattern="$ #,##0.00" />
                                </h:outputText>
                            </p:column>
                            <p:column headerText="Pago" style="text-align: center;" width="100">
                                <h:outputText value="#{emision.pagoFinal}">
                                    <f:convertNumber pattern="$ #,##0.00" />
                                </h:outputText>
                            </p:column>
                        </p:dataTable>
                        <p:contextMenu id="opciones" for="dtEmision" >                            
                            <p:menuitem value="Nada que Mostrar" update="formDetEmision" icon="ui-icon-comment" rendered="#{pagoPrediales.emisionSeleccionada eq null}" />
                            <p:menuitem value="Detalle Emision" oncomplete="PF('dlgDetalle').show();" update="formDetEmision" icon="ui-icon-comment" rendered="#{pagoPrediales.emisionSeleccionada ne null}" process="@this"/>


                        </p:contextMenu>
                    </p:panel>
                </p:tab>
                <p:tab id="pagoPredialRural" title="PAGO PREDIAL RUSTICO" rendered="false">
                    <dialog:consultaCodigoPredial id="consultaRural" tipoConsulta="#{pagoPrediales.tipoConsultaRural}"
                                                  updateConsulta="consultaRural, mainForm:tvRecaudaciones:datosRural"
                                                  predioModel="#{pagoPrediales.predioModel}"
                                                  contribuyenteConsulta="#{pagoPrediales.contribuyenteConsulta}"
                                                  nombreComprador="#{pagoPrediales.nombreComprador}"
                                                  consultaContDirecta="#{pagoPrediales.consultarPorNombreComprador(2)}"
                                                  renderConsultaDirecta="false"
                                                  dlgSolicitante="PF('dlgSolicitanteRustico').show()"
                                                  ciudadelas="#{pagoPrediales.parroquiasRurales}"
                                                  consultarEmisiones="#{pagoPrediales.consultarEmisionesRurales()}"
                                                  updateFrmSolicitante=":frmSolicitanteRustico"
                                                  tipoPredio="false"/>

                    <p:panel id="datosRural">
                        <p:outputLabel value="REG. CATASTRAL: #{pagoPrediales.predioRuralConsulta.regCatastral}" style="font-size: 16px; font-weight: bolder;"/>
                        <p:spacer width="25"/>
                        <p:outputLabel value="ID PREDIAL: #{pagoPrediales.predioRuralConsulta.idPredial}" style="font-size: 16px; font-weight: bolder;"/>
                        <p:spacer width="25"/>
                        <p:outputLabel value="PARROQUIA: #{pagoPrediales.predioRuralConsulta.parroquia.descripcion}" style="font-size: 16px; font-weight: bolder;"/>
                        <p:spacer width="25"/>
                        <p:outputLabel value="TOTAL CANCELAR:" style="font-size: 16px; font-weight: bolder;"/>
                        <p:outputLabel value="#{pagoPrediales.totalEmisiones}" style="font-size: 18px; font-weight: bolder; color: blue;"/>
                        <p:commandButton value="PROCESAR" process="@this" style="font-size: 15px; font-weight: bolder; float: right;" styleClass="btnStyle" icon="ui-icon-gear" iconPos="right" actionListener="#{pagoPrediales.procesarPago}" rendered="#{pagoPrediales.habilitarProcesar()}" /><!--rendered="# {userSession.userId ne 110}"/-->
                        <p:commandButton value="NO ADEUDAR" style="font-size: 14px; font-weight: bolder; float: right;" styleClass="btnStyle" icon="ui-icon-print" iconPos="right" action="#{pagoPrediales.openDialogCertificado()}"   rendered="#{(pagoPrediales.totalEmisionesGeneral eq null or pagoPrediales.totalEmisionesGeneral gt 0.00)?false:true}">
                            <f:setPropertyActionListener target="#{pagoPrediales.tipoCertificado}" value="#{2}" />
                        </p:commandButton>
                        <div style="clear: both;"/>
                        <p:dataTable id="dtEmisionRural" value="#{pagoPrediales.emisionesPrediales}" var="emision"  selection="#{pagoPrediales.emisionesPredialesTemp}" 
                                     rowKey="#{emision.id}" scrollable="true" scrollHeight="350"   selectionMode="multiple" 
                                     lazy="true" reflow="true" rows="100" >
                            <p:ajax event="rowSelect" listener="#{pagoPrediales.seleccionarEmision(2)}" update="mainForm:tvRecaudaciones:datosRural"/>
                            <p:ajax event="rowUnselect" listener="#{pagoPrediales.seleccionarEmision(2)}" update="mainForm:tvRecaudaciones:datosRural"/>
                            <p:ajax event="toggleSelect" listener="#{pagoPrediales.seleccionarEmision(2)}" update="mainForm:tvRecaudaciones:datosRural"/>
                            <p:ajax event="rowSelectCheckbox" listener="#{pagoPrediales.seleccionarEmision(2)}" update="mainForm:tvRecaudaciones:datosRural"/>
                            <p:ajax event="rowUnselectCheckbox" listener="#{pagoPrediales.seleccionarEmision(2)}" update="mainForm:tvRecaudaciones:datosRural"/>
                            <p:column selectionMode="multiple" style="width:16px;text-align:center" rendered="#{pagoPrediales.isSanMiguel}"/>
                            <p:column headerText="*" style="width: 20px;">
                                <p:graphicImage value="/image/circleGreen.png" height="12" rendered="#{emision.estadoLiquidacion.id eq 1 ? true : false}" title="#{emision.estadoLiquidacion.descripcion}"/>
                                <p:graphicImage value="/image/circleRed.png" height="12" rendered="#{emision.estadoLiquidacion.id eq 2 ? true : false}" title="#{emision.estadoLiquidacion.descripcion}"/>
                                <p:graphicImage value="/image/circleOrange.png" height="12" rendered="#{emision.estadoLiquidacion.id eq 4 ? true : false}" title="#{emision.estadoLiquidacion.descripcion}"/>
                            </p:column>
                            <p:column headerText="No." style="text-align: center;"  width="60"><p:outputLabel value="#{emision.numLiquidacion}"/></p:column>
                            <p:column headerText="Año" style="text-align: center;" width="60"><p:outputLabel value="#{emision.anio}"/></p:column>
                            <p:column headerText="Sitio" style="text-align: center;" width="100"><p:outputLabel value="#{emision.predioRustico.sitio}"/></p:column>
                            <!--<p:column headerText="Identificación" style="text-align: center" width="140"><p:outputLabel value="#{emision.comprador.ciRuc}"/></p:column>-->
                            <p:column headerText="Contribuyente" style="text-align: center" width="200" >
                                <p:outputLabel value="#{emision.comprador==null?emision.nombreComprador :emision.comprador.apellidos}#{emision.comprador.nombres}#{emision.comprador.razonSocial}#{emision.comprador.nombreComercial}" title="#{emision.comprador.ciRuc}"/>
                            </p:column>
                            <p:column headerText="Avalúo Catastral" style="text-align: center;" width="100"><p:outputLabel value="#{emision.avaluoMunicipal}"/></p:column>
                            <p:column headerText="Emision" style="text-align: center;" width="100"><p:outputLabel value="#{emision.totalPago}"/></p:column>
                            <p:column headerText="Descuento" style="text-align: center;" width="5%"><p:outputLabel value="#{emision.descuento}"/></p:column>
                            <p:column headerText="Recargo" style="text-align: center;" width="5%"><p:outputLabel value="#{emision.recargo}"/></p:column>
                            <p:column headerText="Interes" style="text-align: center;" width="5%"><p:outputLabel value="#{emision.interes}"/></p:column>
                            <p:column headerText="Pago" style="text-align: center;" width="10%"><p:outputLabel value="#{emision.pagoFinal}"/></p:column>
                        </p:dataTable>
                        <p:contextMenu id="opcionesRural" for="dtEmisionRural">
                            <p:menuitem value="Detalle Emision" oncomplete="PF('dlgDetalle').show();" update="formDetEmision" icon="ui-icon-comment" rendered="#{pagoPrediales.emisionSeleccionada ne null}" process="@this"/>
                            <p:menuitem value="Detalle Pago" oncomplete="PF('dlgDetallePago').show();" update="formDetPago" icon="ui-icon-calculator" rendered="#{pagoPrediales.emisionSeleccionada ne null and (pagoPrediales.emisionSeleccionada.estadoLiquidacion.id eq 1 or pagoPrediales.emisionSeleccionada.estadoLiquidacion.id eq 2)}" process="@this"/>
                            <p:menuitem value="Editar nombre del contribuyente" oncomplete="PF('dlgNombCont').show();" actionListener="#{pagoPrediales.setNombreContribuyente()}" update="formNombCont" icon="ui-icon-comment" rendered="#{pagoPrediales.emisionSeleccionada ne null}" process="@this"/>
                        </p:contextMenu>
                    </p:panel>
                </p:tab>
            </p:tabView>
        </h:form>




        <p:dialog id="dlgSolicitante" widgetVar="dlgSolicitante" header="Listado de contribuyentes" appendTo="@(body)" width="800" responsive="true" closable="true" closeOnEscape="true" modal="true">
            <h:form id="frmSolicitante">
                <p:dataTable id="dtSolicitante" value="#{pagoPrediales.propietarios}" var="s" selection="#{pagoPrediales.propietario}" 
                             rowKey="#{s.id}" style="width: 100%" lazy="true" reflow="true" paginator="true" rows="10" 
                             selectionMode="single" filterEvent="enter" paginatorPosition="top">
                    <!--consultarEmisiones="# {pagoPrediales.consultarEmisiones()}"
                    updateConsulta="consulta, mainForm:tvRecaudaciones:datos"
                    
                    -->
                    <p:ajax event="rowDblselect" listener="#{pagoPrediales.consultarEmisiones()}"  update="mainForm:tvRecaudaciones:consulta, mainForm:tvRecaudaciones:datos" oncomplete="PF('dlgSolicitante').hide()"/>
                    <!--<p:ajax event="rowDblselect" update="mainForm:tvRecaudaciones:consulta" oncomplete="PF('dlgSolicitante').hide()"/>-->
                    <f:facet name="header">Seleccione Contribuyente</f:facet>
                    <p:column headerText="No. Identificacion" sortBy="#{s.ente.ciRuc}" filterBy="#{s.ente.ciRuc}" filterMatchMode="contains" filterStyle="width: 90%;">
                        <h:outputText value="#{s.ente.ciRuc}"/>
                    </p:column>
                    <p:column headerText="Apellidos" filterBy="#{s.ente.apellidos}" sortBy="#{s.ente.apellidos}" filterMatchMode="contains" filterStyle="width: 90%;">
                        <h:outputText value="#{s.ente.apellidos}" style="text-transform: uppercase"/>
                    </p:column>
                    <p:column headerText="Nombres" filterBy="#{s.ente.nombres}" sortBy="#{s.ente.nombres}" filterMatchMode="contains" filterStyle="width: 90%;">
                        <h:outputText value="#{s.ente.nombres}" style="text-transform: uppercase"/>
                    </p:column>
                    <p:column headerText="Razon Social" filterBy="#{s.ente.razonSocial}" sortBy="#{s.ente.razonSocial}"  filterMatchMode="contains" filterStyle="width: 90%;">
                        <h:outputText value="#{s.ente.razonSocial}" style="text-transform: uppercase"/>
                    </p:column>
                    <f:facet name="footer">
                        <p:commandButton id="btnSeleccionar" value="Seleccionar" update="mainForm:tvRecaudaciones:consulta" style="height: 30px" oncomplete="PF('dlgSolicitante').hide()"/>
                    </f:facet>
                </p:dataTable>         
            </h:form>
        </p:dialog>


        <p:dialog header="Listado de Predios - Seleccione Predio" widgetVar="dlgPrediosConsulta" appendTo="@(body)" width="90%" responsive="true" closable="true" closeOnEscape="true" modal="true">
            <h:form id="frmPredios">
                <p:dataTable value="#{pagoPrediales.prediosConsulta}" var="p" selectionMode="single" selection="#{pagoPrediales.predioConsulta}" rowKey="#{p.id}" style="width: 90%; margin: 0 auto;" reflow="true" paginator="true" rows="10" filterEvent="enter" paginatorPosition="top">
                    <p:ajax event="rowDblselect" listener="#{pagoPrediales.seleccionarPredio(1)}" update="mainForm:tvRecaudaciones:datos"/>
                    <p:column headerText="No. Predio" sortBy="#{p.numPredio}" width="10%" filterBy="#{p.numPredio}" filterMatchMode="exact" filterStyle="width: 95%;"><h:outputText value="#{p.numPredio}"/></p:column>
                    <p:column headerText="Cod. Predial" filterBy="#{p.claveCat}" filterMatchMode="contains" filterStyle="width: 90%;"><h:outputText value="#{p.claveCat}"/></p:column>
                    <p:column headerText="Propietario" filterBy="#{p.nombrePropietarios}" filterMatchMode="contains"  filterStyle="width: 90%;"><h:outputText value="#{p.nombrePropietarios}"/></p:column>
                    <p:column headerText="Urbanizacion" filterBy="#{p.direccion}" filterMatchMode="contains" filterStyle="width: 90%;">
                        <h:outputText value="#{p.direccion}"/>
                    </p:column>
                    <p:column headerText="Mz" width="10%" filterBy="#{p.mz}" filterMatchMode="exact" filterStyle="width: 90%;"><h:outputText value="#{p.mz}"/></p:column>
                    <p:column headerText="Sl" width="10%"><h:outputText value="#{p.solar}"/></p:column>
                    <f:facet name="footer">
                        <p:commandButton value="Seleccionar" actionListener="#{pagoPrediales.seleccionarPredio(1)}" update="mainForm:tvRecaudaciones:datos"/>
                        <p:spacer width="15"/>
                        <p:commandButton value="Seleccionar Todo" actionListener="#{pagoPrediales.seleccionarPredio(3)}" update="mainForm:tvRecaudaciones:datos" rendered="false"/>
                    </f:facet>
                </p:dataTable>         
            </h:form>
        </p:dialog>


        <p:dialog header="ADVERTENCIA" widgetVar="dlgMensaje" resizable="false" closeOnEscape="true" modal="true" width="200">
            <h:form id="formMensaje">
                <p:panelGrid styleClass="noBorder" columns="1">
                    <p:outputLabel value="El predio consultado tiene Titulos de Credito en COACTIVA!!!" style="font-size: 14px;font-weight: bolder;text-align: center;color: #0033FF;"/>
                </p:panelGrid>
            </h:form>
        </p:dialog>



        <p:dialog header="Detalle Emision" widgetVar="dlgDetalle" resizable="false" closeOnEscape="true" modal="true" width="80%" position="center">
            <h:form id="formDetEmision">
                <dialog:detalleLiquidacion liquidacion="#{pagoPrediales.emisionSeleccionada}"/>
                <center><p:commandButton value="Aceptar" oncomplete="PF('dlgDetalle').hide();" styleClass="btnStyle"/></center>
            </h:form>
        </p:dialog>



    </ui:define>
</ui:composition>
