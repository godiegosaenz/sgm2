

CREATE OR REPLACE FUNCTION censocat.update_entes_execpcionales_sgm()
  RETURNS void AS
$BODY$
DECLARE SECUENCIAMAX BIGINT;
DECLARE
	C_CONTACTOS CURSOR FOR 
		--DEPUES DE HABER MIGRADOS LOS ENTES PUEDEN EXISTIR ALGUNOS QUE TENGAN CI_RUC 
		--CON PALABRAS ESTAA FUNCION ES PARA HACER A ESTOS EXCEPCIONALES
		--SELECT  DISTINCT IDENTIFICACION FROM CENSOCAT.CONTACTO WHERE IDENTIFICACION  ~ '^[A-Z]'
		--SELECT  DISTINCT IDENTIFICACION FROM CENSOCAT.CONTACTO WHERE IDENTIFICACION  ~ '^[a-z]'
		SELECT ID FROM SGM_APP.CAT_ENTE WHERE CI_RUC IN
		('ruc','sin información','falta ruc','sin informacion ','s/i','Ruc','S/i',
		'SIn informacion','Sin información ',
		'Sin informacion','S/I', 'S','MONTALVAN FLORES');
BEGIN

	FOR C IN C_CONTACTOS LOOP

		SECUENCIAMAX = (SELECT MAX(SECUENCIA)+1 FROM SGM_SECUENCIAS.ENTE_SECUENCIA);
		SECUENCIAMAX := SECUENCIAMAX + 1;
		
		INSERT INTO SGM_SECUENCIAS.ENTE_SECUENCIA(anio, secuencia) VALUES ((select extract(year from now())), SECUENCIAMAX);
		
		UPDATE SGM_APP.CAT_ENTE SET CI_RUC = SECUENCIAMAX  AND EXCEPCIONALES = TRUE  WHERE ID = C.ID;
	END LOOP;
	
END;

$BODY$
  LANGUAGE plpgsql VOLATILE
  COST 100;
ALTER FUNCTION censocat.update_entes_execpcionales_sgm()
  OWNER TO sisapp;