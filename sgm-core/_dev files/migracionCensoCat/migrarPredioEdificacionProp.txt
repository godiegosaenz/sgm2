-- Function: censocat.migrar_predio_edificacion_caracteristica()

-- DROP FUNCTION censocat.migrar_predio_edificacion_caracteristica();

CREATE OR REPLACE FUNCTION censocat.migrar_predio_edificacion_caracteristica()
  RETURNS void AS
$BODY$
DECLARE TIPO_CONJ BIGINT;
DECLARE
	C_CARACTERISTICA CURSOR FOR
		SELECT CARACT.ID, EDIFICACION, CARACTERISTICA, PORCENTAJE, EDIF.PREDIO, CARACT.ESTADO 
                 FROM CENSOCAT.EDIFICACION_CARACT CARACT
		INNER JOIN SGM_APP.CAT_PREDIO_EDIFICACION EDIF ON EDIF.ID  = CARACT.EDIFICACION WHERE CARACTERISTICA IS NOT NULL  ;
	ACIERTOS INTEGER := 0;
	
BEGIN
	FOR C IN C_CARACTERISTICA LOOP

	                IF ((SELECT COUNT(ID) FROM  SGM_APP.CAT_PREDIO_EDIFICACION_PROP PO WHERE PO.EDIFICACION=C.EDIFICACION AND PO.PROP = C.CARACTERISTICA)=0) THEN    
				INSERT INTO SGM_APP.CAT_PREDIO_EDIFICACION_PROP(id, edificacion, prop, porcentaje, predio, estado)
				VALUES (C.ID, C.EDIFICACION, C.CARACTERISTICA, C.PORCENTAJE, C.PREDIO, C.ESTADO );
				ACIERTOS := ACIERTOS +1;
		        ELSE
			END IF;
			
			
	END LOOP;
	RAISE NOTICE 'PREDIOS CREADOS %',ACIERTOS;
	ACIERTOS := 0;
END;

$BODY$
  LANGUAGE plpgsql VOLATILE
  COST 100;
ALTER FUNCTION censocat.migrar_predio_edificacion_caracteristica()
  OWNER TO sisapp;
