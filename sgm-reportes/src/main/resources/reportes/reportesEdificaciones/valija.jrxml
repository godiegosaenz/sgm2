<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="valija" pageWidth="595" pageHeight="842" whenNoDataType="AllSectionsNoDetail" columnWidth="555" leftMargin="20" rightMargin="20" topMargin="20" bottomMargin="20" uuid="89d152c2-b294-4592-b332-cbf723b35cca">
	<property name="ireport.zoom" value="1.0"/>
	<property name="ireport.x" value="0"/>
	<property name="ireport.y" value="0"/>
	<parameter name="LOGO_URL" class="java.lang.String">
		<defaultValueExpression><![CDATA["C:\\Users\\supergold\\Documents\\sgm\\src\\main\\webapp\\css\\homeIconsImages\\logo.jpg"]]></defaultValueExpression>
	</parameter>
	<parameter name="ESTADO" class="java.lang.String">
		<defaultValueExpression><![CDATA[]]></defaultValueExpression>
	</parameter>
	<parameter name="FECHA_INICIO" class="java.lang.String">
		<defaultValueExpression><![CDATA[]]></defaultValueExpression>
	</parameter>
	<parameter name="FECHA_FIN" class="java.lang.String">
		<defaultValueExpression><![CDATA[]]></defaultValueExpression>
	</parameter>
	<queryString>
		<![CDATA[SELECT
    ht.id AS numtramite,
    (CASE WHEN ht.urbmz IS NOT NULL AND ht.urbsolar IS NOT NULL THEN
          ('Mz ' || ht.urbmz || ' Sl ' || ht.urbsolar)
        WHEN ht.urbmz IS NULL AND ht.urbsolar IS NULL THEN
          'Mz - Sl -'
        WHEN ht.urbmz IS NULL THEN
          ('Mz - Sl ' || ht.urbsolar)
        WHEN ht.urbsolar IS NULL THEN
          ('Mz ' || ht.urbmz || ' Sl -')
        ELSE
          'Mz - Sl -'
     END ) AS mzsl,
    (CASE WHEN ht.nombre_propietario IS NOT NULL THEN
          ht.nombre_propietario
        ELSE
          (SELECT CASE WHEN E.ES_PERSONA THEN (E.NOMBRES || ' ' || E.APELLIDOS)
             ELSE
                E.RAZON_SOCIAL END FROM sgm_app.CAT_ENTE E WHERE E.ID = ht.solicitante)
     END) AS solicitante,
    (CASE WHEN t.id = 6 THEN
          (SELECT 'P.A. ' || A.DESCRIPCION FROM sgm_app.pe_tipo_permiso_adicionales A
          LEFT JOIN sgm_app.pe_permisos_adicionales PA ON(PA.tipo_permiso_adicional = A.ID)
          WHERE A.TIENE_VALIJA = TRUE AND PA.NUM_TRAMITE = ht.ID)
        WHEN ht.tipo_tramite_nombre IS NULL THEN
          t.descripcion
        ELSE
          ht.tipo_tramite_nombre
     END) AS tipotramite_nombre_principal,
    ht.fecha AS fechainicio,
    ht.estado AS estadotramite,
    (SELECT razon_social from sgm_application.empresa) AS nombre_empresa
FROM
    sgm_flow.historico_tramites AS ht left join sgm_flow.otros_tramites AS ot ON (ot.id=ht.sub_tipo_tramite)
    LEFT JOIN sgm_app.ge_tipo_tramite t ON (t.id = ht.tipo_tramite)
WHERE
    UPPER(ht.estado)=UPPER($P{ESTADO}) AND
    TO_CHAR(ht.fecha, 'YYYY-MM-DD') BETWEEN $P{FECHA_INICIO} AND $P{FECHA_FIN} AND
    (CASE WHEN T.ID = 6 THEN
            (SELECT A.TIENE_VALIJA FROM sgm_app.pe_tipo_permiso_adicionales A
            LEFT JOIN sgm_app.pe_permisos_adicionales PA ON(PA.tipo_permiso_adicional = A.ID)
            WHERE PA.NUM_TRAMITE = ht.ID) = TRUE
        ELSE
            t.tiene_valija = true
        END)
ORDER BY
    ht.id ASC]]>
	</queryString>
	<field name="numtramite" class="java.lang.Long"/>
	<field name="mzsl" class="java.lang.String"/>
	<field name="solicitante" class="java.lang.String"/>
	<field name="tipotramite_nombre_principal" class="java.lang.String"/>
	<field name="fechainicio" class="java.sql.Timestamp"/>
	<field name="estadotramite" class="java.lang.String"/>
	<field name="nombre_empresa" class="java.lang.String"/>
	<background>
		<band splitType="Stretch"/>
	</background>
	<title>
		<band height="103" splitType="Stretch">
			<image>
				<reportElement x="3" y="1" width="106" height="90" uuid="d123ee27-78ba-469a-9b83-44055a1e9bbd"/>
				<imageExpression><![CDATA[$P{LOGO_URL}]]></imageExpression>
			</image>
			<line>
				<reportElement x="3" y="101" width="552" height="1" uuid="909c056e-7e93-4474-ba8e-867e7760dd12"/>
				<graphicElement>
					<pen lineWidth="3.0" lineStyle="Double" lineColor="#00CC00"/>
				</graphicElement>
			</line>
			<textField>
				<reportElement x="127" y="1" width="428" height="100" uuid="93affca5-0bba-47e4-8684-e90c2e578e8a"/>
				<textElement textAlignment="Center" verticalAlignment="Bottom">
					<font size="14" isBold="true"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{nombre_empresa}]]></textFieldExpression>
			</textField>
		</band>
	</title>
	<pageHeader>
		<band splitType="Stretch"/>
	</pageHeader>
	<columnHeader>
		<band height="20" splitType="Stretch">
			<staticText>
				<reportElement x="0" y="0" width="65" height="20" uuid="eb2cfdea-0fd8-47b1-b2f2-ddabedccf1fc"/>
				<textElement textAlignment="Center">
					<font size="14" isBold="true"/>
				</textElement>
				<text><![CDATA[# Trámite]]></text>
			</staticText>
			<staticText>
				<reportElement x="65" y="0" width="302" height="20" uuid="2e625ff0-bbff-4335-a3ed-1d61b2e541c0"/>
				<textElement textAlignment="Center">
					<font size="14" isBold="true"/>
				</textElement>
				<text><![CDATA[Tipo Trámite]]></text>
			</staticText>
			<staticText>
				<reportElement x="367" y="0" width="188" height="20" uuid="563105f9-81a2-4b97-bc37-d4390aaaf08b"/>
				<textElement textAlignment="Center">
					<font size="14" isBold="true"/>
				</textElement>
				<text><![CDATA[Solicitante]]></text>
			</staticText>
		</band>
	</columnHeader>
	<detail>
		<band height="20" splitType="Stretch">
			<textField isBlankWhenNull="true">
				<reportElement x="0" y="0" width="65" height="20" uuid="6f766e82-b391-4888-983b-79cf64ce2139"/>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font isBold="true"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{numtramite}]]></textFieldExpression>
			</textField>
			<textField isBlankWhenNull="true">
				<reportElement x="65" y="0" width="302" height="20" uuid="db0269df-ee78-4dd1-a753-e5997dacd915"/>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font isBold="true"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{tipotramite_nombre_principal}]]></textFieldExpression>
			</textField>
			<textField isBlankWhenNull="true">
				<reportElement x="367" y="0" width="188" height="20" uuid="0c6b6aa7-a1c9-4be3-b90b-a2467acfa978"/>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font isBold="true"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{solicitante}]]></textFieldExpression>
			</textField>
		</band>
	</detail>
	<columnFooter>
		<band splitType="Stretch"/>
	</columnFooter>
	<pageFooter>
		<band splitType="Stretch"/>
	</pageFooter>
	<summary>
		<band splitType="Stretch"/>
	</summary>
</jasperReport>
